{% extends 'base.html' %}
{% block content %}

	<script type="text/javascript" charset="utf-8">
		function format_time(type, unix_time) {
			var date = new Date(unix_time * 1000);

			if (type == "hour" || type == "day") {
				return date.toString("HH:mm M/d/yyyy");
			}
			if (type == 'week') {
				return date.toString("HH:mm M/d/yyyy");
			}
			return date.toString("M/d/yyyy");
		}

		function get_tool_tip_div(hits, unix_date) {
			hits_str = ""
			if (hits == null) {
				hits_str = "stream offline";
			}
			else {
				hits_str = hits + " viewers";
			}

			tool_tip = $('<div>').addClass("graph-tooltip-label");
			$('<p>').addClass("graph-tooltip-number")
				.html(hits_str).appendTo(tool_tip);
			$('<p>').addClass("graph-tooltip-date")
				.html(unix_date).appendTo(tool_tip);
			return tool_tip;
		}

		function load_graph(type) {
			var the_values, the_tooltips, the_labels;

			// query for the data
			$.getJSON('http://{{ current_site }}/{{ stream.id }}' + '/' + type + '/',
				function(data) {
					the_values = new Array(data.length);
					the_tooltips = new Array(data.length);
					the_labels = new Array(data.length);
					$.each(data, function(index, point) {
						date_str = format_time(type, point['date']);
						the_tooltips[index] = get_tool_tip_div(point['number'],
															   date_str);
						the_labels[index] = index + 1;
						if (point['number'] == null) {
							the_values[index] = 0;
						}
						else {
							the_values[index] = point['number'];
						}
					});

					$("#graph").chart("clear");
					$("#graph").chart({
						template: "streamnumbers-" + type,
						tooltips: the_tooltips,
						values: {
							serie1: the_values,
						},
						labels: the_labels,
					});
				}
			);
		}

		$(function() {
			load_graph('hour');
		});
	</script>
	<div id="details">
		<h1>{{ stream.name }}</h1>
		<div id="details-menu">
			<a href="#" onclick="load_graph('hour')"> hour </a>
			<a href="#" onclick="load_graph('day')"> day </a>
			<a href="#" onclick="load_graph('week')"> week </a>
			<a href="#" onclick="load_graph('month')"> month </a>
		</div>
		<div id="graph">
		</div>
	</div>
	<div id="stream-id" style="display: none">
		{{ stream.id }}
	</div>
{% endblock %}
